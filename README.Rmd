---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# rmdl

<!-- badges: start -->

[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental) 
[![Github commit frequency](https://img.shields.io/github/commit-activity/w/asshah4/rmdl)](https://github.com/asshah4/rmdl/graphs/commit-activity) 
[![R-CMD-check](https://github.com/asshah4/rmdl/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/asshah4/rmdl/actions/workflows/R-CMD-check.yaml)
[![test-coverage](https://github.com/asshah4/vlndr/actions/workflows/test-coverage.yaml/badge.svg)](https://github.com/asshah4/vlndr/actions/workflows/test-coverage.yaml)
<!-- badges: end -->

## Installation

This package can be downloaded from CRAN or from [Github](https://github.com/asshah4/rmdl) as below

```{r, eval = FALSE}
# CRAN installation
install.packages("rmdl")
# Or remote/developmental version
remotes::install_github("asshah4/rmdl")
```

## Introduction

The package `rmdl` was intended as a way to handle causal- and epidemiology-based modeling by the following principles:

1. Role determination of variables
2. Generativity in formula creation
3. Multiple model management

## Usage

The package is simple to use. 
First, lets load the basic packages. 
The `mtcars` dataset will serve as the example, and we will use linear regressions as the primary test.

```{r}
library(rmdl)
```

There are several important extended classes that this package introduces, however they are primarily used for internal validation and for shortcuts to allow more effective communication.

- `<fmls>` are a *version* of the base `R` formula object, but contain additional information and have extra features
- `<tm>` are atomic elements used to describe individual variables, and departs from how terms are generally treated in the `{stats}` package
- `<mdl>` and `<mdl_tbl>` exist primarily as *tidy* versions of class regression modeling

We will see how they come together below. 
Next, we will evaluate a toy dataset and evaluate how a `<fmls>` object is generated.

```{r}
# Look at potential data from the `mtcars` dataset
head(mtcars)

baseFormula <- mpg ~ wt + hp
rFormula <- fmls(mpg ~ wt + hp)

# Similar to the base formula
rFormula
```

Now we can fit the hypothesis to its data - in this case, a simple linear regression.
The option to return the model as raw or not is given. 
If `TRUE`, the default, then the expected result from the modeling fit will be returned in the form of a list of models, based on the fitting function provided.

```{r}
# Uses a custom fit function to return linear models
listModels <-
  rFormula |>
  fit(.fn = lm, data = mtcars, raw = TRUE)
```

For our purposes though, we want to use the custom fit method, which retains more key information.
This creates a `<mdl>` object, which is simply a wrapper around base or package-specific models.

```{r}
# Uses a custom fit function 
rModel <-
  rFormula |>
  fit(.fn = lm, data = mtcars, raw = FALSE)

rModel
```

The model wrapper is helpful in that it can be unpacked into a table of elements, which then stores our model for later usage in a research workflow.
For this purpose, we introduce the `<mdl_tbl>` class, which another core class with specific and generic dispatch methods.

```{r}
# An additional model to work with
r2Model <-
  fmls(am ~ cyl + hp, pattern = "sequential") |>
  fit(.fn = glm, family = "binomial", data = mtcars, raw = FALSE)

# Displays the two additional logistic regressions performed
r2Model

# Creation of a table of models
rTable <- model_table(mileage = rModel, automatic = r2Model)
rTable
```

The `<mdl_tbl>` class is a useful way to store and manage multiple models, and can be used to generate tables for publication or for internal use.
To quickly access the content (e.g. estimates, standard errors, etc.), there is an experimental function called `flatten_models()` that can be used.
Note that we are also exponentiating the coefficients for the logistic regression models (called by name).

```{r}
fTable <-
  rTable |>
  flatten_models(exponentiate = TRUE, which = "automatic") 

# Display contents
fTable

# Filter down to relevant models
fTable |>
  dplyr::select(name, number, outcome, term, estimate, conf_low, conf_high, p_value, nobs)
```

## Advanced usage

The power of the `{rmdl}` package is partially in its flexibility with formulas. Please see the vignettes for further details on usage.
